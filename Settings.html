<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/styles.css">
    <style>
      /* Using Google's standard font and adding some padding */
      body { 
        padding: 10px; 
        font-family: 'Roboto', sans-serif; 
      }
      .form-group { 
        margin-bottom: 15px; 
      }
      /* Styling for the status message that appears after saving */
      #status { 
        margin-top: 10px; 
        font-weight: bold; 
      }
      .success { 
        color: #097138; /* Google's green for success */
      }
      .error { 
        color: #c21a0f; /* Google's red for errors */
      }
    </style>
  </head>
  <body>
    <h3>Uploader Settings</h3>
    
    <div class="form-group">
      <label for="subdomain">Zendesk Subdomain</label>
      <input type="text" id="subdomain" class="form-input" placeholder="e.g., yourcompany">
    </div>

    <div class="form-group">
      <label for="email">Zendesk Admin Email</label>
      <input type="text" id="email" class="form-input" placeholder="e.g., admin@yourcompany.com">
    </div>

    <div class="form-group">
      <label for="apiKey">Zendesk API Token</label>
      <input type="password" id="apiKey" class="form-input" placeholder="Paste your API token here">
    </div>
    
    <div class="form-group">
      <input type="checkbox" id="ignoreHeader">
      <label for="ignoreHeader">First row is a header</label>
    </div>

    <button class="action" onclick="saveSettings()">Save Settings</button>
    
    <div id="status"></div>

    <script>
      // When the sidebar loads, ask the server for the currently saved settings
      document.addEventListener('DOMContentLoaded', function() {
        google.script.run.withSuccessHandler(function(settings) {
          if (settings) {
            document.getElementById('subdomain').value = settings.subdomain || '';
            document.getElementById('email').value = settings.email || '';
            document.getElementById('ignoreHeader').checked = settings.ignoreHeader;
            // For security, we do not re-populate the API key field.
          }
        }).getSettings();
      });

      function saveSettings() {
        var statusEl = document.getElementById('status');
        statusEl.textContent = "Saving...";
        statusEl.className = ''; // Reset class
        
        var settings = {
          subdomain: document.getElementById('subdomain').value,
          email: document.getElementById('email').value,
          apiKey: document.getElementById('apiKey').value,
          ignoreHeader: document.getElementById('ignoreHeader').checked
        };

        // Check if API key is entered, as it's not pre-filled
        if (!settings.apiKey) {
            // If there's an existing auth token, the user might not need to re-enter the key.
            // But if it's the first setup, we should ask for it.
             google.script.run.withSuccessHandler(function(existingSettings){
                if(!existingSettings.authToken){
                     statusEl.textContent = "Please enter an API Token.";
                     statusEl.className = 'error';
                } else {
                     // If a token already exists, an empty API field means "don't change the token"
                     save(settings, statusEl);
                }
             }).getSettings();
        } else {
            save(settings, statusEl);
        }
      }

      function save(settings, statusEl){
         google.script.run.withSuccessHandler(function(response) {
            statusEl.textContent = response;
            statusEl.className = 'success';
            // Clear the API key field after a successful save
            document.getElementById('apiKey').value = ''; 
            setTimeout(function(){ statusEl.textContent = ''; }, 4000);
        }).withFailureHandler(function(err){
            statusEl.textContent = "Error: " + err.message;
            statusEl.className = 'error';
        }).saveSettings(settings);
      }
    </script>
  </body>
</html>